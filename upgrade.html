<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>Datalevin Database Upgrade</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="css/highlight.css" /><script type="text/javascript" src="js/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html"><span class="project-title"><span class="project-name">Datalevin</span> <span class="project-version">0.6.16</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Topics</span></h3><ul><li class="depth-1 "><a href="dtlv.html"><div class="inner"><span>Datalevin Command Line Tool</span></div></a></li><li class="depth-1 "><a href="search.html"><div class="inner"><span>Datalevin Search Engine</span></div></a></li><li class="depth-1 "><a href="server.html"><div class="inner"><span>Datalevin Server/Client</span></div></a></li><li class="depth-1  current"><a href="upgrade.html"><div class="inner"><span>Datalevin Database Upgrade</span></div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>datalevin</span></div></div></li><li class="depth-2 branch"><a href="datalevin.client.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>client</span></div></a></li><li class="depth-2 branch"><a href="datalevin.core.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core</span></div></a></li><li class="depth-2 branch"><a href="datalevin.interpret.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>interpret</span></div></a></li><li class="depth-2"><a href="datalevin.search-utils.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>search-utils</span></div></a></li></ul></div><div class="document" id="content"><div class="doc"><div class="markdown"><h1><a href="#datalevin-database-upgrade" name="datalevin-database-upgrade"></a>Datalevin Database Upgrade</h1>
<p>Before introducing steps to upgrade Datalevin databases, let us discuss the versioning of Datalevin, so we have the right expectations as to when a database upgrade is needed.</p>
<h2><a href="#versioning" name="versioning"></a>Versioning</h2>
<p>Datalevin version numbers roughly follow this numbering schema: <code>major.minor.non-breaking</code>.</p>
<p><code>major</code> version bumps means Datalevin having reached a major milestone in functionality. For example, we will bump the version to 1.0.0 when we have rewritten the query engine and reached feature parity (minus temporal features) with Datomic in term of Datalog processing. Such version changes may or may not requires data migration, as these may have little to do with concrete data encoding and storage changes.</p>
<p><code>minor</code>version number change indicate big code changes that ship new features. These often involve breaking changes that requires data migration, even when the impact of the changes on data encoding is not obvious. For example, the version number goes from 0.4.x to 0.5.x when we introduced client/server mode, and some databases needed migration when this happened.</p>
<p><code>non-breaking</code> version number indicates small code changes that do not break existing API or affect existing databases. These are bug fixes or minor feature introductions. No data migration should be expected for such version bumps.</p>
<p>In summary, we should expect that minor version number changes require migrating existing databases when upgrading. Major version bumps may not require migration  if you are diligent in following the minor version upgrades, but if you are  not, data migration is needed. Non-breaking version bumps do not require data  migration.</p>
<h2><a href="#database-upgrade" name="database-upgrade"></a>Database Upgrade</h2>
<p>Now we know when a database upgrade is needed, here is how to do it.</p>
<p>Upgrading a database from an old version to a new version requires the use of Datalevin command line tool, <code>dtlv</code>, or <code>datalevin-x.x.x-standalone.jar</code> uberjar if a native build does not exist on your platform. In fact, both the old and the new versions of the command tool are needed.</p>
<p>For example, we want to upgrade a Datalog database that has been running in Datalevin 0.4.x to run in Datalevin 0.5.x.</p>
<ol>
  <li>Download the latest versions of both versions of <code>dtlv</code> tool. Rename the  older version, e.g. 0.4.44 binary from <code>dtlv</code> to <code>dtlv-0.4</code>.</li>
</ol>
<pre><code class="console">wget https://github.com/juji-io/datalevin/releases/download/0.4.44/dtlv-0.4.44-macos-latest-amd64.zip

unzip dtlv-0.4.44-macos-latest-amd64.zip

mv dtlv dtlv-0.4

wget https://github.com/juji-io/datalevin/releases/download/0.5.21/dtlv-0.5.21-macos-latest-amd64.zip

unzip dtlv-0.5.21-macos-latest-amd64.zip
</code></pre>
<ol>
  <li>Backup the current database first, e.g.</li>
</ol>
<pre><code class="console">./dtlv-0.4 -d /src/dir -c copy /backup/dir
</code></pre>
<p>This also compacts the data file, so it’s not huge. Ideally, one would run a cron job to backup daily for production databases.</p>
<ol>
  <li>Dump the current database as a text file, e.g.</li>
</ol>
<pre><code class="console">./dtlv-0.4 -d /src/dir -g -f dump-file dump
</code></pre>
<p>This dumps the content of the Datalog database to a file called <code>dump-file</code>. The format of the database dump is version independent.</p>
<ol>
  <li>Import the data into the new version of database using new version of the tool, e.g.</li>
</ol>
<pre><code class="console">./dtlv -d /dest/dir -f dump-file -g load
</code></pre>
<p>Now your new Datalog database is in <code>/dest/dir</code>. That’s it.</p>
<p>If the database is a key-value store instead of a Datalog one, the dump and load commands have different options, please consult the <code>dtlv help dump</code> and <code>dtlv help load</code> for details.</p></div></div></div></body></html>